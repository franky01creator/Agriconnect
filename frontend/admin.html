<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agriconnect Admin Analytics</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-page-body">
    <div class="header">
        <div class="logo">
            <i class="fas fa-leaf"></i>
            <span>Agriconnect Admin</span>
        </div>
        <nav class="nav-menu">
            <ul>
                <li class="active"><a href="admin.html"><i class="fas fa-chart-pie"></i> Analytics</a></li>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Farmer Hub</a></li>
                <li><a href="supplier.html"><i class="fas fa-handshake"></i> Supplier Hub</a></li>
                <li><a href="marketplace.html"><i class="fas fa-store"></i> Marketplace</a></li>
                <li><a href="message.html"><i class="fas fa-envelope"></i> Messages</a></li>
            </ul>
        </nav>
        <div class="user-actions">
            <a href="#"><i class="fas fa-user-shield"></i> Admin</a>
            <a href="#" id="signOutBtn"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    </div>

    <div class="dashboard-container">
        <h2 class="welcome-message">Application Analytics</h2>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon metric-icon-blue"><i class="fas fa-users"></i></div>
                <div>
                    <p class="metric-label">Active Users</p>
                    <p class="metric-value" id="activeUsers">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-green"><i class="fas fa-seedling"></i></div>
                <div>
                    <p class="metric-label">Suppliers</p>
                    <p class="metric-value" id="supplierCount">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-orange"><i class="fas fa-shopping-basket"></i></div>
                <div>
                    <p class="metric-label">Active Listings</p>
                    <p class="metric-value" id="listingCount">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-star"><i class="fas fa-dollar-sign"></i></div>
                <div>
                    <p class="metric-label">Monthly Revenue</p>
                    <p class="metric-value" id="revenueTotal">$0</p>
                </div>
            </div>
        </div>

        <div class="dashboard-sections-grid">
            <div class="card" style="grid-column: span 2;">
                <h3 class="section-title">User Growth (Monthly)</h3>
                <canvas id="userGrowthChart" height="120"></canvas>
            </div>
            <div class="card">
                <h3 class="section-title">User Segmentation</h3>
                <canvas id="userRoleChart" height="220"></canvas>
            </div>
            <div class="card">
                <h3 class="section-title">Top Supplier Categories</h3>
                <canvas id="supplierCategoryChart" height="220"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top: 30px;">
            <h3 class="section-title">Recent Activity</h3>
            <div id="activityFeed">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <script>
        let analyticsCharts = {
            userGrowth: null,
            userRoles: null,
            supplierCategories: null
        };

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');

            if (!token || !userStr) {
                window.location.href = 'welcome.html';
                return;
            }

            document.getElementById('signOutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                localStorage.removeItem('cart');
                window.location.href = 'welcome.html';
            });

            fetchAnalytics(token);
        });

        async function fetchAnalytics(token) {
            const statusMessage = document.getElementById('activityFeed');
            statusMessage.innerHTML = '<p style="padding: 15px; text-align: center; color: #7f8c8d;">Loading analytics...</p>';

            try {
                const response = await fetch('http://localhost:5001/api/admin/analytics', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    alert('Session expired. Please log in again.');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = 'welcome.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load analytics');
                }

                const data = await response.json();
                populateMetrics(data.metrics);
                renderCharts(data.charts);
                renderActivityFeed(data.activity);
            } catch (error) {
                console.error('Analytics error:', error);
                statusMessage.innerHTML = '<p style="padding: 15px; text-align: center; color: #e74c3c;">Unable to load analytics. Please try again later.</p>';
            }
        }

        function populateMetrics(metrics) {
            document.getElementById('activeUsers').textContent = metrics.activeUsers?.toLocaleString() || '0';
            document.getElementById('supplierCount').textContent = metrics.supplierCount?.toLocaleString() || '0';
            document.getElementById('listingCount').textContent = metrics.listingCount?.toLocaleString() || '0';
            document.getElementById('revenueTotal').textContent = `$${(metrics.inventoryValue || 0).toLocaleString()}`;
        }

        function renderCharts(chartsData) {
            renderUserGrowthChart(chartsData.userGrowth);
            renderUserRoleChart(chartsData.userRoles);
            renderSupplierCategoryChart(chartsData.supplierCategories);
        }

        function renderUserGrowthChart(chartData = { labels: [], data: [] }) {
            const ctx = document.getElementById('userGrowthChart');
            if (analyticsCharts.userGrowth) analyticsCharts.userGrowth.destroy();
            analyticsCharts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'New Signups',
                        data: chartData.data,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.15)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 3,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#7f8c8d' } },
                        x: { ticks: { color: '#7f8c8d' } }
                    }
                }
            });
        }

        function renderUserRoleChart(chartData = { labels: [], data: [] }) {
            const ctx = document.getElementById('userRoleChart');
            if (analyticsCharts.userRoles) analyticsCharts.userRoles.destroy();
            analyticsCharts.userRoles = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.data,
                        backgroundColor: ['#27ae60', '#2980b9', '#e67e22'],
                        hoverOffset: 6
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderSupplierCategoryChart(chartData = { labels: [], data: [] }) {
            const ctx = document.getElementById('supplierCategoryChart');
            if (analyticsCharts.supplierCategories) analyticsCharts.supplierCategories.destroy();
            analyticsCharts.supplierCategories = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Listed Items',
                        data: chartData.data,
                        backgroundColor: '#8e44ad',
                        borderRadius: 6
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#7f8c8d' } },
                        x: { ticks: { color: '#7f8c8d' } }
                    }
                }
            });
        }

        function renderActivityFeed(activity = []) {
            const container = document.getElementById('activityFeed');
            container.innerHTML = '';

            if (activity.length === 0) {
                container.innerHTML = '<p style="padding: 15px; text-align: center; color: #7f8c8d;">No recent activity.</p>';
                return;
            }

            activity.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;';
                row.innerHTML = `
                    <div style="width: 42px; height: 42px; border-radius: 50%; background: ${item.color}10; color: ${item.color}; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 15px;">
                        <i class="fas ${item.icon}"></i>
                    </div>
                    <div>
                        <p style="margin: 0; color: #555;">${item.text}</p>
                        <small style="color: #95a5a6;">${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                `;
                container.appendChild(row);
            });
        }
    </script>
</body>
</html>

