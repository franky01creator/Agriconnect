<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Hub - Agriconnect</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="supplier-hub-page-body">
    <div class="header">
        <div class="logo">
            <i class="fas fa-leaf"></i>
            <span>Agriconnect</span>
        </div>
        <nav class="nav-menu">
            <ul>
                <li><a href="supplier.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="marketplace.html"><i class="fas fa-store"></i> Marketplace</a></li>
                <li class="active"><a href="supplier-hub.html"><i class="fas fa-handshake"></i> Supplier</a></li>
                <li><a href="knowledge.html"><i class="fas fa-book"></i> Knowledge Hub</a></li>
                <li><a href="message.html"><i class="fas fa-envelope"></i> Messages</a></li>
            </ul>
        </nav>
        <div class="user-actions">
            <a href="#"><i class="fas fa-user-circle"></i> Account</a>
            <a href="#" id="signOutBtn"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    </div>

    <div class="supplier-hub-container">
        <h1 class="welcome-message" id="welcomeMessage">Welcome, Supplier!</h1>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon metric-icon-green"><i class="fas fa-dolly-flatbed"></i></div>
                <div>
                    <p class="metric-label">Orders to Process</p>
                    <p class="metric-value" id="ordersCount">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-blue"><i class="fas fa-boxes"></i></div>
                <div>
                    <p class="metric-label">Total Products Listed</p>
                    <p class="metric-value" id="productCount">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-orange"><i class="fas fa-chart-line"></i></div>
                <div>
                    <p class="metric-label">Revenue This Month</p>
                    <p class="metric-value" id="revenueCount">$0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon metric-icon-star"><i class="fas fa-star"></i></div>
                <div>
                    <p class="metric-label">Average Customer Rating</p>
                    <p class="metric-value">4.8</p>
                </div>
            </div>
        </div>

        <div class="hub-sections-grid-uniform">
            
            <!-- 1. My Supplier Catalog Section -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2 class="section-title">My Supplier Catalog</h2>
                <div id="listingsLoader" style="text-align: center; padding: 20px; display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #2ecc71;"></i>
                    <p style="margin-top: 10px;">Loading your products...</p>
                </div>
                <div class="listings-grid" id="supplierListings">
                    <!-- Products will be loaded dynamically from database -->
                </div>
                <div id="emptyListings" style="text-align: center; padding: 40px; color: #7f8c8d; display: none;">
                    <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>No products listed yet. Add your first supplier item below!</p>
                </div>
            </div>

            <!-- 2. NEW: Add Supplier Product Form -->
            <div class="card product-listing-card" id="add-product-section" style="grid-column: 1 / -1;">
                <h2 class="form-section-title">List New Supplier Item</h2>
                <form id="supplierProductForm">
                    <div class="form-grid">
                        <!-- Picture URL (Simulated upload) -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="product-image-url">Product Image URL </label>
                            <input type="text" id="product-image-url" placeholder="https://example.com/image.jpg" value="">
                        </div>

                        <!-- Title -->
                        <div class="form-group">
                            <label for="product-title">Product Title</label>
                            <input type="text" id="product-title" placeholder="e.g., Organic Seeds, Tractor Model X" required>
                        </div>

                        <!-- Category (Hidden/Fixed for backend compatibility) -->
                        <input type="hidden" id="product-category" value="supplier-supplies">

                        <!-- Price -->
                        <div class="form-group">
                            <label for="product-price">Price</label>
                            <input type="number" id="product-price" step="0.01" placeholder="0.00" required>
                        </div>
                         <div class="form-group">
                            <label for="product-unit">Unit</label>
                             <select id="product-unit">
                                 <option value="item">Per Item</option>
                                 <option value="kg">Per Kg</option>
                                 <option value="bag">Per Bag</option>
                                 <option value="day">Per Day (Rental)</option>
                                 <option value="dozen">Per Dozen</option>
                             </select>
                        </div>

                        <!-- Quantity -->
                        <div class="form-group">
                            <label for="product-quantity">Available Quantity</label>
                            <input type="number" id="product-quantity" min="1" placeholder="100" value="999" required>
                        </div>

                        <!-- Location -->
                        <div class="form-group">
                            <label for="product-location">Location</label>
                            <input type="text" id="product-location" placeholder="e.g., Nairobi, Mombasa Road" required>
                        </div>

                        <!-- Min Order -->
                        <div class="form-group">
                            <label for="product-min-order">Minimum Order Quantity</label>
                            <input type="number" id="product-min-order" min="1" placeholder="1" value="1" required>
                        </div>

                        <!-- Description -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="product-description">Description</label>
                            <textarea id="product-description" rows="3" placeholder="Describe your machinery, fertilizer, or seeds..." required></textarea>
                        </div>
                    </div>

                    <div id="form-message" style="margin-top: 15px; display: none;"></div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">List Item</button>
                    </div>
                </form>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-card card">
                <h2 class="section-title">Quick Actions</h2>
                <div class="action-buttons-grid">
                    <button class="quick-action-button primary-action" id="addProductBtn"><i class="fas fa-plus-circle"></i> Add New Product</button>
                    <button class="quick-action-button" id="manageInventoryBtn"><i class="fas fa-boxes"></i> Manage Inventory</button>
                    <button class="quick-action-button" id="viewOrdersBtn"><i class="fas fa-clipboard-list"></i> View Orders</button>
                </div>
            </div>

            <!-- Orders Section (Hidden by default) -->
            <div class="card" id="ordersSection" style="grid-column: 1 / -1; display: none;">
                <h2 class="section-title">Orders Management</h2>
                <div id="ordersContent" style="padding: 20px;">
                    <p style="color: #7f8c8d; text-align: center;">Order management system coming soon. This will show all orders for your supplier products.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // Global variables
        let allSupplierProducts = [];
        let currentUser = null;
        let authToken = null;

        // Base API URL helper (local vs deployed)
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:5001'
            : 'https://agriconnect-lhhe.onrender.com';

        document.addEventListener('DOMContentLoaded', async () => {
            authToken = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');

            if (!authToken || !userStr) {
                window.location.href = 'welcome.html';
                return;
            }

            currentUser = JSON.parse(userStr);

            // Check user role - Redirect non-suppliers to their appropriate dashboard
            if (currentUser && currentUser.role) {
                const userRole = currentUser.role.toLowerCase();
                if (userRole === 'farmer') {
                    window.location.href = 'dashboard.html';
                    return;
                } else if (userRole === 'buyer') {
                    // Buyers can access marketplace or dashboard
                    window.location.href = 'marketplace.html';
                    return;
                }
                // Suppliers can stay on this page
            }

            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.fullName || 'Supplier'}!`;

            // Sign Out
            document.getElementById('signOutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                // Clear all user data including cart
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                localStorage.removeItem('cart'); // Clear shopping cart
                window.location.href = 'welcome.html';
            });

            // Quick Action Buttons
            document.getElementById('addProductBtn').addEventListener('click', () => {
                document.getElementById('add-product-section').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('manageInventoryBtn').addEventListener('click', () => {
                document.getElementById('supplierListings').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('viewOrdersBtn').addEventListener('click', () => {
                const ordersSection = document.getElementById('ordersSection');
                if (ordersSection.style.display === 'none') {
                    ordersSection.style.display = 'block';
                    ordersSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    ordersSection.style.display = 'none';
                }
            });

            // Load supplier products from database
            await fetchSupplierProducts();

            // Handle form submission
            setupFormSubmission();
        });

        // Fetch supplier products from database
        async function fetchSupplierProducts() {
            const loader = document.getElementById('listingsLoader');
            const listingsGrid = document.getElementById('supplierListings');
            const emptyListings = document.getElementById('emptyListings');

            loader.style.display = 'block';
            listingsGrid.innerHTML = '';
            emptyListings.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/my-listings`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }

                allSupplierProducts = await response.json();
                loader.style.display = 'none';

                // Filter to show only supplier-related products (optional, or show all)
                // For now, we'll show all products listed by this user
                
                if (allSupplierProducts.length === 0) {
                    emptyListings.style.display = 'block';
                } else {
                    renderSupplierProducts(allSupplierProducts);
                }

                // Always update the metrics, even when there are zero products
                updateMetrics(allSupplierProducts);

            } catch (error) {
                console.error('Error fetching products:', error);
                loader.style.display = 'none';
                listingsGrid.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error loading products: ${error.message}</p>`;
            }
        }

        // Render supplier products
        function renderSupplierProducts(products) {
            const listingsGrid = document.getElementById('supplierListings');
            listingsGrid.innerHTML = '';

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.productId = product._id;

                const imageUrl = product.imageUrl || 'https://via.placeholder.com/300x200/e8f5e9/27ae60?text=Supplier+Product';
                const description = product.description || 'No description available.';
                const shortDescription = description.length > 100 ? description.substring(0, 100) + '...' : description;

                card.innerHTML = `
                    <div class="product-image-wrapper" style="position: relative;">
                        <img src="${imageUrl}" alt="${product.productName}" class="product-image" 
                             onerror="this.src='https://via.placeholder.com/300x200/e8f5e9/27ae60?text=Supplier+Product'">
                        <button class="delete-product-btn" onclick="deleteProduct('${product._id}')" 
                                style="position: absolute; top: 8px; right: 8px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9em;"
                                title="Delete Product">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h4 class="product-name">${product.productName}</h4>
                    <p class="product-description" style="font-size: 0.9em; color: #666; margin-bottom: 5px;">${shortDescription}</p>
                    <p class="product-farm"><i class="fas fa-map-marker-alt"></i> Location: ${product.farmLocation || 'Not specified'}</p>
                    <p class="product-price"><strong>$${product.price.toFixed(2)}</strong> / ${product.unit}</p>
                    <p style="font-size: 0.85em; color: #95a5a6; margin-top: 5px;">
                        <i class="fas fa-box"></i> Stock: ${product.quantity} ${product.unit}
                    </p>
                `;
                listingsGrid.appendChild(card);
            });
        }

        // Update metrics based on real data
        function updateMetrics(products) {
            // Total products = number of listings for this supplier
            // Update product count
            document.getElementById('productCount').textContent = products.length;

            // Estimate *this month's* potential revenue using createdAt timestamps.
            // Since there is no orders API yet, we approximate using products
            // created in the last 30 days and assume 10% of stock is sold.
            const now = new Date();
            const thirtyDaysAgo = new Date(now);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const monthlyEstimatedRevenue = products.reduce((sum, product) => {
                // createdAt comes from MongoDB timestamps and is returned as a string
                const createdAt = product.createdAt ? new Date(product.createdAt) : null;

                if (!createdAt || createdAt < thirtyDaysAgo) {
                    return sum;
                }

                const price = typeof product.price === 'number' ? product.price : 0;
                const quantity = typeof product.quantity === 'number' ? product.quantity : 0;

                // Assume 10% of available stock sells within the month
                const estimatedSold = quantity * 0.1;
                return sum + price * estimatedSold;
            }, 0);

            document.getElementById('revenueCount').textContent = `$${monthlyEstimatedRevenue.toFixed(0)}`;

            // Orders to process â€“ real value would come from an Orders API.
            // For now, this is set to 0 so it always reflects a dynamic value, not a hardcoded demo number.
            document.getElementById('ordersCount').textContent = '0';
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`https://agriconnect-lhhe.onrender.com/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    // Remove from local array
                    allSupplierProducts = allSupplierProducts.filter(p => p._id !== productId);
                    renderSupplierProducts(allSupplierProducts);
                    updateMetrics(allSupplierProducts);
                    
                    // Show success message
                    const formMessage = document.getElementById('form-message');
                    formMessage.textContent = 'Product deleted successfully!';
                    formMessage.style.color = 'green';
                    formMessage.style.display = 'block';
                    setTimeout(() => {
                        formMessage.style.display = 'none';
                    }, 3000);
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to delete product');
                }
            } catch (error) {
                alert(`Error deleting product: ${error.message}`);
            }
        }

        // Setup form submission
        function setupFormSubmission() {
            const supplierForm = document.getElementById('supplierProductForm');
            const formMessage = document.getElementById('form-message');

            supplierForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const productData = {
                    productName: document.getElementById('product-title').value.trim(),
                    category: document.getElementById('product-category').value || 'supplier-goods',
                    description: document.getElementById('product-description').value.trim(),
                    farmLocation: document.getElementById('product-location').value.trim(),
                    price: parseFloat(document.getElementById('product-price').value),
                    unit: document.getElementById('product-unit').value,
                    quantity: parseInt(document.getElementById('product-quantity').value) || 999,
                    minOrder: parseInt(document.getElementById('product-min-order').value) || 1,
                    imageUrl: document.getElementById('product-image-url').value.trim() || ''
                };

                // Validation
                if (!productData.productName || !productData.description || !productData.farmLocation || !productData.price) {
                    formMessage.textContent = 'Please fill in all required fields.';
                    formMessage.style.color = 'red';
                    formMessage.style.display = 'block';
                    return;
                }

                formMessage.style.display = 'none';

                try {
                    const response = await fetch('https://agriconnect-lhhe.onrender.com/api/products', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(productData)
                    });

                    if (response.ok) {
                        const newProduct = await response.json();
                        
                        // Refresh the product list
                        await fetchSupplierProducts();

                        // Show success message
                        formMessage.textContent = 'Item listed successfully!';
                        formMessage.style.color = 'green';
                        formMessage.style.display = 'block';
                        
                        // Reset form
                        supplierForm.reset();
                        document.getElementById('product-image-url').value = 'https://via.placeholder.com/300x200?text=New+Product';

                        // Scroll to top of listings
                        setTimeout(() => {
                            document.getElementById('supplierListings').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 500);

                    } else {
                        const err = await response.json();
                        throw new Error(err.message || 'Failed to list item');
                    }
                } catch (error) {
                    formMessage.textContent = `Error: ${error.message}`;
                    formMessage.style.color = 'red';
                    formMessage.style.display = 'block';
                }
            });
        }
    </script>
</body>
</html>